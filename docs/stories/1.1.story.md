# Story 1.1: 网格策略创建与配置

## Status
Draft

## Story
**As a** 网格交易者 (Grid Trader),
**I want** to create a grid strategy and set basic parameters via a CLI command,
**so that** I can define my trading strategy framework.

## Acceptance Criteria
1.  A CLI command `grid create` is available.
2.  The command accepts the following arguments: `pair`, `upper` (upper_price), `lower` (lower_price), `grids` (grid_count).
3.  The command accepts the following optional arguments: `amount` (base_amount), `type` (grid_type, 'arithmetic' or 'geometric').
4.  When executed successfully, a new strategy record is saved to the `grid_strategies` table in the database.
5.  The new strategy has a unique ID and its status is set to 'stopped' by default.
6.  The command outputs the ID of the newly created strategy.
7.  Input validation is performed for all parameters.

## Tasks / Subtasks
- [ ] **Task 1: Implement Data Model and Repository (AC: 4, 5)**
  - [ ] Define the `GridStrategy` interface in `src/models/GridStrategy.ts` according to the data model.
  - [ ] Create `src/repositories/StrategyRepository.ts` that extends `BaseRepository<GridStrategy>`.
  - [ ] Implement the `save` method to insert/replace a strategy in the `grid_strategies` table.
- [ ] **Task 2: Implement Core Strategy Engine (AC: 4, 5)**
  - [ ] Create `src/services/StrategyEngine.ts`.
  - [ ] Implement a `createStrategy` method that takes a strategy configuration object.
  - [ ] The method should generate a unique ID for the new strategy.
  - [ ] It should call the `StrategyRepository` to persist the new strategy.
- [ ] **Task 3: Implement CLI Command (AC: 1, 2, 3, 6)**
  - [ ] Create `src/cli/commands/GridCommand.ts`.
  - [ ] Use `commander.js` to define the `create` command with all required and optional arguments.
  - [ ] Implement the command's action to parse inputs and call the `StrategyController`.
- [ ] **Task 4: Implement Strategy Controller (AC: 7)**
  - [ ] Create `src/controllers/StrategyController.ts`.
  - [ ] Implement a `createStrategy` method that receives the configuration from the CLI command.
  - [ ] Perform validation on the input parameters (e.g., `upper_price` > `lower_price`).
  - [ ] Orchestrate the call to the `StrategyEngine` and return the result.
- [ ] **Task 5: Write Unit and Integration Tests (AC: 1-7)**
  - [ ] Write unit tests for `StrategyRepository` using a mock database.
  - [ ] Write unit tests for `StrategyEngine` mocking the repository.
  - [ ] Write unit tests for `StrategyController`.
  - [ ] Write integration tests for the `grid create` command in `tests/integration/cli-commands.test.ts` that uses the real database helper to verify data persistence.

## Dev Notes

### Previous Story Insights
Story 0.6 established the complete testing framework (Vitest), CI/CD, mock services, and test helpers. This provides a robust foundation for Test-Driven Development (TDD). All new logic for strategy creation must be accompanied by comprehensive unit and integration tests.

### CLI Command Specification
The `grid create` command is the primary user interface for this story.
**Command:** `grid create <pair> --upper <price> --lower <price> --grids <num> [--amount <value>] [--type <arithmetic|geometric>]`
[Source: `architecture/api-specification.md`]

### Data Model & Persistence
This story will create a new record in the `grid_strategies` table.
- **Model:** `GridStrategy`
- **Interface:** `src/models/GridStrategy.ts`
- **Schema:**
  - `id`: TEXT PRIMARY KEY
  - `wallet_address`: TEXT NOT NULL
  - `pair`: TEXT NOT NULL
  - `network`: TEXT NOT NULL
  - `grid_type`: TEXT NOT NULL ('arithmetic' or 'geometric')
  - `upper_price`: REAL NOT NULL
  - `lower_price`: REAL NOT NULL
  - `grid_count`: INTEGER NOT NULL
  - `base_amount`: REAL NOT NULL
  - `status`: TEXT NOT NULL ('stopped')
[Source: `architecture/data-models.md`, `architecture/database-schema.md`]

### Backend Architecture
The logic is orchestrated through a controller and service layer.
- **CLI Handler:** `src/cli/commands/GridCommand.ts` will parse user input.
- **Controller:** `src/controllers/StrategyController.ts` will validate and orchestrate the creation process.
- **Service:** `src/services/StrategyEngine.ts` will contain the core business logic for creating the strategy object.
- **Repository:** `src/repositories/StrategyRepository.ts` will handle the database interaction, saving the new `GridStrategy` entity.
[Source: `architecture/backend-architecture.md`]

### File Locations
- **Command:** `src/cli/commands/GridCommand.ts`
- **Controller:** `src/controllers/StrategyController.ts`
- **Service:** `src/services/StrategyEngine.ts`
- **Repository:** `src/repositories/StrategyRepository.ts`
- **Model:** `src/models/GridStrategy.ts`
- **Unit Tests:** `tests/unit/services/strategy-engine.test.ts`, `tests/unit/repositories/strategy-repository.test.ts`
- **Integration Test:** `tests/integration/cli-commands.test.ts`
[Source: `architecture/unified-project-structure.md`]

### Testing Requirements
- Core logic for strategy creation must have 100% test coverage. [Source: `architecture/coding-standards.md`]
- Unit tests should mock dependencies (e.g., repositories, services).
- Integration tests must use the `DatabaseTestHelper` to set up a test database and verify that the `grid create` command correctly persists a new strategy. [Source: `architecture/testing-strategy.md`]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-13 | 1.0 | Initial story draft created from Epic 1. | Bob (Scrum Master) |
